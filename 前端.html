<!DOCTYPE html>
<html>
<head>
    <title>Stream Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>


<div class="container">
  <h1>ğŸ‘‹åŸºäºå€ºæƒå¤§æ¨¡å‹çš„èŠå¤©æœºå™¨äººğŸ‘‹ğŸ¤–</h1>
  <h2>èŠå¤©è®°å½•</h2>
</div>



<div class="history-container">
    <div id="history" style="height: 600px; overflow-y: auto"></div>

</div>

<div class="container1">
    <div class="input"><textarea id="input" placeholder="è¯·è¾“å…¥æ‚¨æƒ³é—®çš„é—®é¢˜"></textarea></div>
    <div class="audio-btn"><button id="audio-btn">ğŸ™ï¸</button></div>
    <div class="cancel-btn"><button id="cancel-btn">åˆ é™¤</button></div>
    <div class="start-btn"><button id="start-btn">å‘é€</button></div>
</div>

    <script>
          let questionHistory = []; // å­˜å‚¨ç”¨æˆ·æå‡ºçš„é—®é¢˜
        let currentQuestionIndex = -1; // å½“å‰æ˜¾ç¤ºçš„é—®é¢˜åœ¨å†å²ä¸­çš„ç´¢å¼•

        const inputTextarea = document.getElementById('input');

        // ç›‘å¬é”®ç›˜æŒ‰é”®äº‹ä»¶
        inputTextarea.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                showPreviousQuestion();
                console.log("æŒ‰é”®æˆåŠŸ")
            }
        });
        console.log(questionHistory.length);
        // æ˜¾ç¤ºä¸Šä¸€ä¸ªé—®é¢˜
        function showPreviousQuestion() {
            if (questionHistory.length === 0) return;

            if (currentQuestionIndex === -1) {
                currentQuestionIndex = questionHistory.length - 1;
            } else if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
            }

            inputTextarea.value = questionHistory[currentQuestionIndex];
            console.log(inputTextarea.value)
        }

        // æ·»åŠ æ–°é—®é¢˜åˆ°å†å²è®°å½•
        function addToQuestionHistory(question) {
            questionHistory.push(question);
            currentQuestionIndex = -1; // é‡ç½®ç´¢å¼•ï¼Œä»¥ä¾¿åœ¨æŒ‰ä¸Šç®­å¤´æ—¶ä»æœ€æ–°é—®é¢˜å¼€å§‹
        }

        var xhr;
        var startBtn = document.getElementById("start-btn");
        {#var output = document.getElementById("output");#}
        var cancelBtn = document.getElementById("cancel-btn");
        var audioBtn = document.getElementById("audio-btn");
        var input = document.getElementById("input");
        var lastText = '';

        startBtn.addEventListener("click", function() {

            var chatDiv = document.getElementById('history');

            var UserDiv = document.createElement('div');
            UserDiv.innerHTML = '<div style="font-size: 1.5em;">ğŸ¤¡</div>';
            chatDiv.appendChild(UserDiv);

            var text_user = input.value;
            var UserLogDiv = document.createElement('div');
            UserLogDiv.style="background-color: #F0F0F0; border-radius: 16px; max-width: 80%; margin: 10px 0; padding: 12px; display: inline-block;"
            UserLogDiv.innerText = text_user;
            chatDiv.appendChild(UserLogDiv);
            const question = inputTextarea.value.trim();

            if (question !== '') {
                addToQuestionHistory(question);
                input.value = '';
            }


            var BotDiv = document.createElement('div');
            BotDiv.innerHTML = '<div style="font-size: 1.5em;">ğŸ¤–</div>';
            chatDiv.appendChild(BotDiv);

            var BotLogDiv = document.createElement('div');
            BotLogDiv.style="background-color: #CCEEB6; border-radius: 16px; max-width: 80%; margin: 10px 0; padding: 12px; display: inline-block;"
            chatDiv.appendChild(BotLogDiv);
            var output = chatDiv.lastElementChild;

            var output1 = document.createElement('div');  // Create a new output element
            chatDiv.appendChild(output1);
            if (xhr && xhr.readyState !== XMLHttpRequest.DONE) {
              xhr.abort();
            }
            output.textContent = 'å·²æ”¶åˆ°è¯·æ±‚ï¼Œæ­£åœ¨ç«­åŠ›åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...';
            let totalEdgeMoney = 0;
            xhr = new XMLHttpRequest();
            var url = "/stream?text=" + encodeURIComponent(text_user);
            {#xhr.open("GET", "/stream");#}
            xhr.open("GET", url);
            xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
            console.log(xhr)
            console.log(xhr.setRequestHeader)
            if (chatDiv.scrollHeight > chatDiv.clientHeight) {
               chatDiv.scrollTop =  Math.floor(chatDiv.scrollHeight - chatDiv.clientHeight);
            }

            xhr.onreadystatechange = function() {



                if (xhr.readyState == 4 && xhr.status == 200) {
                    var decodedData = JSON.parse(xhr.responseText);
                    // è¾“å‡ºå®Œæ•´çš„å“åº”åˆ°æ§åˆ¶å°
                    console.log(decodedData);
                    const output_type = decodedData.output_type;

                    if (decodedData && decodedData.output) {

                        if (output_type === "string") {
                            // Assuming output is a reference to the output element
                            console.log("neiromhg", decodedData.output)
                            output.textContent = decodedData.output;

                        } else if (decodedData.output.data.count[0].total === 0) {

                            output.textContent = "ä¸å­˜åœ¨å¯ç”¨æ•°æ®!è¯·é‡æ–°è¾“å…¥...";

                        } else if (output_type === "neo4j_data" && (decodedData.output.data.task_name === 'get_child_to_child_debt'||decodedData.output.data.task_name ==='get_child_to_child_debt_by_details' )) {
                           // åˆ›å»ºä¸€ä¸ªæ–°çš„è¡¨æ ¼å®¹å™¨
                            var newTableContainer = document.createElement('div');
                            newTableContainer.id = 'TableContainer' + Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³æ¥ç¡®ä¿IDçš„å”¯ä¸€æ€§
                            newTableContainer.className = 'table-container';

                            {#var tableContainer = document.getElementById('TableContainer');#}

                            const taskData = decodedData.output.data.data;
                            const taskName = decodedData.output.data.task_name;
                            const totalCount = decodedData.output.data.count[0].total;
                            const state = decodedData.output.msg;
                            console.log('Task Name:', taskName);
                            console.log('Total Count:', totalCount);
                            console.log('Task Data:', taskData);
                            console.log('state:', state);
                            {#tableContainer.innerHTML = '';#}
                            newTableContainer.innerHTML = '';
                            // Display the data in a table
                            var table = '<table border="1">';
                            // è¿™ä¸ªæ˜¯æŸ¥è¯¢ä¸€å®¶å…¬å¸åˆ°å¦ä¸€å®¶å…¬å¸çš„åº”ä»˜è´¦æ¬¾
                            // é—®é¢˜ï¼šå±±ä¸œçœå…¬è·¯æ¡¥æ¢å»ºè®¾é›†å›¢æœ‰é™å…¬å¸æ¡¥æ¢å…»æŠ¤ç§‘æŠ€å…¬å¸ç»™å±±ä¸œé«˜é€Ÿå·¥ç¨‹æ£€æµ‹æœ‰é™å…¬å¸çš„åº”ä»˜è´¦æ¬¾æŸ¥è¯¢

                            table += '<tr><th>ä»˜æ¬¾å•ä½ç¼–å·</th><th>ä»˜æ¬¾å•ä½åç§°</th><th>ä»˜æ¬¾å•ä½æ€§è´¨</th><th>åº”ä»˜è´¦æ¬¾</th><th>é¡¹ç›®ç¼–å·</th><th>é¡¹ç›®æ˜ç»†ç¼–å·</th><th>é¡¹ç›®åç§°</th><th>é¡¹ç›®æ˜ç»†</th><th>æ”¶æ¬¾å•ä½ç¼–å·</th><th>æ”¶æ¬¾å•ä½åç§°</th><th>æ”¶æ¬¾å•ä½æ€§è´¨</th></tr>';

                            taskData.forEach(item => {
                                const child1 = item.child1 || {};
                                const edge = item.edge || {};
                                const child2 = item.child2 || {};

                                const child1Number = child1.number || 'None';
                                const child1Name = child1.name || 'None';
                                const child1Label = child1.label || 'None';
                                const edgeMoney = edge.money || 'None';
                                const edgePNumber = edge.p_number || 'None';
                                const edgeSNumber = edge.s_number || 'None';
                                const edgePName = edge.p_name || 'None';
                                const edgeSDetail = edge.s_detail || 'None';
                                const child2Number = child2.number || 'None';
                                const child2Name = child2.name || 'None';
                                const child2Label = child2.label || 'None';
                                totalEdgeMoney += parseFloat(edgeMoney); // å°† edgeMoney çš„å€¼ç´¯åŠ åˆ° totalEdgeMoney ä¸­

                                table += `<tr>
                                            <td>${child1Number}</td>
                                            <td>${child1Name}</td>
                                            <td>${child1Label}</td>
                                            <td>${edgeMoney}</td>
                                            <td>${edgePNumber}</td>
                                            <td>${edgeSNumber}</td>
                                            <td>${edgePName}</td>
                                            <td>${edgeSDetail}</td>
                                            <td>${child2Number}</td>
                                            <td>${child2Name}</td>
                                            <td>${child2Label}</td>
                                        </tr>`;
                            });
                            table += '</tbody></table>';

                            output.textContent = state + "æˆ‘ä¸€å…±æ‰¾åˆ°äº†" + totalCount + "æ¡ä¿¡æ¯å…±" + totalEdgeMoney + "å…ƒå¹¶ä»¥è¡¨æ ¼çš„å½¢å¼å±•ç¤º";
                            newTableContainer.innerHTML = table;
                            var newOutputContainer = document.createElement('div');
                            newOutputContainer.className = 'output-container'; // æ·»åŠ ä¸€ä¸ªç±»åï¼Œä»¥ä¾¿äºæ ·å¼ç®¡ç†
                            // å°†è¡¨æ ¼å®¹å™¨æ·»åŠ åˆ°è¾“å‡ºå®¹å™¨ä¸­
                            newOutputContainer.appendChild(newTableContainer);
                            newOutputContainer.style.marginTop = '20px';
                            newOutputContainer.style.width = '100%';
                            var historyContainer = document.getElementById('history');
                            // å°†æ–°çš„è¾“å‡ºå®¹å™¨æ·»åŠ åˆ°å†å²å®¹å™¨ä¸­
                            historyContainer.appendChild(newOutputContainer);

                        } else if (output_type === "neo4j_data" && decodedData.output.data.task_name === 'get_child_receivables') {

                            var newTableContainer = document.createElement('div');
                            newTableContainer.id = 'TableContainer' + Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³æ¥ç¡®ä¿IDçš„å”¯ä¸€æ€§
                            newTableContainer.className = 'table-container';
                            const taskData = decodedData.output.data.data;
                            const taskName = decodedData.output.data.task_name;
                            const totalCount = decodedData.output.data.count[0].total;
                            const company = decodedData.output.data.data[0].child.name;
                            const state = decodedData.output.msg;
                            console.log('Task Name:', taskName);
                            console.log('Total Count:', totalCount);
                            console.log('Task Data:', taskData);
                            console.log('state:', state);
                            newTableContainer.innerHTML = ''

                            var table = '<table border="1">';
                            table += '<tr><th>å­å•ä½ç¼–å·</th><th>å­å•ä½åç§°</th><th>å­å•ä½æ€§è´¨</th><th>å­å•ä½åº”æ”¶è´¦æ¬¾</th><th>é¡¹ç›®ç¼–å·</th><th>ä¸šåŠ¡æ˜ç»†ç¼–å·</th><th>é¡¹ç›®åç§°</th><th>ä¸šåŠ¡æ˜ç»†</th><th>æ¯å•ä½ç¼–å·</th><th>æ¯å•ä½åç§°</th><th>æ¯å•ä½æ€§è´¨</th></tr>';
                            // è·å–æŸå®¶å…¬å¸çš„åº”ä»˜è´¦æ¬¾
                            // é—®é¢˜ï¼šå±±ä¸œé«˜é€Ÿè±é’¢ç»¿å»ºå‘å±•æœ‰é™å…¬å¸æ·„åšé’¢æ„åˆ†å…¬å¸çš„åº”æ”¶è´¦æ¬¾æ˜¯å¤šå°‘
                            taskData.forEach(item => {
                                const other = item.other || {};
                                const edge = item.edge || {};
                                const child = item.child || {};

                                const otherNumber = other.number || 'None';
                                const otherName = other.name || 'None';
                                const otherLabel = other.label || 'None';
                                const edgeMoney = edge.money || 'None';
                                const edgePNumber = edge.p_number || 'None';
                                const edgeSNumber = edge.s_number || 'None';
                                const edgePName = edge.p_name || 'None';
                                const edgeSDetail = edge.s_detail || 'None';
                                const childNumber = child.number || 'None';
                                const childName = child.name || 'None';
                                const childLabel = child.label || 'None';
                                totalEdgeMoney += parseFloat(edgeMoney);
                                table += `<tr>
                                            <td>${otherNumber}</td>
                                            <td>${otherName}</td>
                                            <td>${otherLabel}</td>
                                            <td>${edgeMoney}</td>
                                            <td>${edgePNumber}</td>
                                            <td>${edgeSNumber}</td>
                                            <td>${edgePName}</td>
                                            <td>${edgeSDetail}</td>
                                            <td>${childNumber}</td>
                                            <td>${childName}</td>
                                            <td>${childLabel}</td>
                                        </tr>`;
                            });
                            table += '</tbody></table>';

                            output.textContent = state + "æˆ‘ä¸€å…±æ‰¾åˆ°äº†" + totalCount + "æ¡"+ company +"æ‰€æœ‰åº”æ”¶è´¦æ¬¾ä¿¡æ¯å…±"+ totalEdgeMoney +"å…ƒå¹¶ä»¥è¡¨æ ¼çš„å½¢å¼å±•ç¤º";
                            newTableContainer.innerHTML = table;
                            var newOutputContainer = document.createElement('div');
                            newOutputContainer.className = 'output-container'; // æ·»åŠ ä¸€ä¸ªç±»åï¼Œä»¥ä¾¿äºæ ·å¼ç®¡ç†
                            // å°†è¡¨æ ¼å®¹å™¨æ·»åŠ åˆ°è¾“å‡ºå®¹å™¨ä¸­
                            newOutputContainer.appendChild(newTableContainer);
                            newOutputContainer.style.marginTop = '20px';
                            newOutputContainer.style.width = '100%';
                            var historyContainer = document.getElementById('history');
                            // å°†æ–°çš„è¾“å‡ºå®¹å™¨æ·»åŠ åˆ°å†å²å®¹å™¨ä¸­
                            historyContainer.appendChild(newOutputContainer);
                        } else if (output_type === "neo4j_data" && decodedData.output.data.task_name === 'get_child_node') {

                            {#var tableContainer = document.getElementById('TableContainer');#}
                            var newTableContainer = document.createElement('div');
                            newTableContainer.id = 'TableContainer' + Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³æ¥ç¡®ä¿IDçš„å”¯ä¸€æ€§
                            newTableContainer.className = 'table-container';

                            const taskData = decodedData.output.data.data;
                            const taskName = decodedData.output.data.task_name;
                            const totalCount = decodedData.output.data.count[0].total;
                            const state = decodedData.output.msg;
                            console.log('Task Name:', taskName);
                            console.log('Total Count:', totalCount);
                            console.log('Task Data:', taskData);
                            console.log('state:', state);
                            newTableContainer.innerHTML = '';

                            var table = '<table border="1">';
                            // è·å–ä¸€å®¶å…¬å¸æœ‰å“ªäº›å­å…¬å¸
                            // æ¬§äºšç­åˆ—å…¬å¸çš„å­å…¬å¸æœ‰é‚£äº›
                            table += '<tr><th>æ¯å•ä½ç¼–å·</th><th>æ¯å•ä½åç§°</th><th>æ¯å•ä½æ€§è´¨</th><th>å­å•ä½ç¼–å·</th><th>å­å•ä½åç§°</th><th>å­å•ä½æ€§è´¨</th></tr>';
                            {#table += '<tr><th>parent_Number</th><th>par_Name</th><th>par_Label</th><th>Money</th><th>P Number</th><th>S Number</th><th>P Name</th><th>S Detail</th><th>Child Number</th><th>Child Name</th><th>Child Label</th></tr>';#}
                            taskData.forEach(item => {
                                const parent = item.parent || {};
                                const edge = item.edge || {};
                                const child = item.child || {};

                                const parent_Number = parent.number || 'None';
                                const par_Name = parent.name || 'None';
                                const par_rLabel = parent.label || 'None';
                                const childNumber = child.number || 'None';
                                const childName = child.name || 'None';
                                const childLabel = child.label || 'None';

                                table += `<tr>
                                            <td>${parent_Number}</td>
                                            <td>${par_Name}</td>
                                            <td>${par_rLabel}</td>
                                            <td>${childNumber}</td>
                                            <td>${childName}</td>
                                            <td>${childLabel}</td>
                                        </tr>`;
                            });
                            table += '</tbody></table>';

                            output.textContent = '';
                            output.textContent = state + "æˆ‘ä¸€å…±æ‰¾åˆ°äº†" + totalCount + "æ¡ä¿¡æ¯,å¹¶ä»¥è¡¨æ ¼çš„å½¢å¼å±•ç¤º";

                            newTableContainer.innerHTML = table;
                            var newOutputContainer = document.createElement('div');
                            newOutputContainer.className = 'output-container'; // æ·»åŠ ä¸€ä¸ªç±»åï¼Œä»¥ä¾¿äºæ ·å¼ç®¡ç†
                            // å°†è¡¨æ ¼å®¹å™¨æ·»åŠ åˆ°è¾“å‡ºå®¹å™¨ä¸­
                            newOutputContainer.appendChild(newTableContainer);
                            newOutputContainer.style.marginTop = '20px';
                            newOutputContainer.style.width = '100%';
                            var historyContainer = document.getElementById('history');
                            // å°†æ–°çš„è¾“å‡ºå®¹å™¨æ·»åŠ åˆ°å†å²å®¹å™¨ä¸­
                            historyContainer.appendChild(newOutputContainer);


                        } else if (output_type === "neo4j_data" && decodedData.output.data.task_name === 'get_child_ring') {

                            var newTableContainer = document.createElement('div');
                            newTableContainer.id = 'TableContainer' + Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³æ¥ç¡®ä¿IDçš„å”¯ä¸€æ€§
                            newTableContainer.className = 'table-container';

                            const taskData = decodedData.output.data.data;
                            const taskName = decodedData.output.data.task_name;
                            const totalCount = decodedData.output.data.count[0].total;
                            const state = decodedData.output.msg;
                            console.log('Task Name:', taskName);
                            console.log('Total Count:', totalCount);
                            console.log('Task Data:', taskData);
                            console.log('state:', state);
                            newTableContainer.innerHTML = '';

                            var table = '<table border="1">';
                            table += '<tr><th>èŠ‚ç‚¹ç¼–å·1</th><th>èŠ‚ç‚¹åç§°1</th><th>å•ä½æ€§è´¨1</th><th>åº”ä»˜é‡‘é¢1</th><th>é¡¹ç›®ç¼–å·1</th><th>ä¸šåŠ¡æ˜ç»†ç¼–å·1</th><th>ä¸šåŠ¡æ˜ç»†åç§°1</th><th>ä¸šåŠ¡ç»†èŠ‚1</th>' +
                                '<th>èŠ‚ç‚¹ç¼–å·2</th><th>èŠ‚ç‚¹åç§°2</th><th>å•ä½æ€§è´¨2</th><th>åº”ä»˜é‡‘é¢2</th><th>é¡¹ç›®ç¼–å·2</th><th>ä¸šåŠ¡æ˜ç»†ç¼–å·2</th><th>ä¸šåŠ¡æ˜ç»†åç§°2</th><th>ä¸šåŠ¡ç»†èŠ‚2</th>'+
                                '<th>èŠ‚ç‚¹ç¼–å·3</th><th>èŠ‚ç‚¹åç§°3</th><th>å•ä½æ€§è´¨3</th><th>åº”ä»˜é‡‘é¢3</th><th>é¡¹ç›®ç¼–å·3</th><th>ä¸šåŠ¡æ˜ç»†ç¼–å·3</th><th>ä¸šåŠ¡æ˜ç»†åç§°3</th><th>ä¸šåŠ¡ç»†èŠ‚3</th></tr>';
                            // æŸ¥è¯¢ä¸‰è§’å€º
                            taskData.forEach(item => {
                                const Node1 = item.path[0].Node || {};
                                const Node1_edge = item.path[1].HAS_DEBT || {};
                                const Node2 = item.path[2].Node || {};
                                const Node2_edge = item.path[3].HAS_DEBT || {};
                                const Node3 = item.path[4].Node || {};
                                const Node3_edge = item.path[5].HAS_DEBT|| {};

                                const Node1_number = Node1.number || 'None';
                                const Node1_Name = Node1.name || 'None';
                                const Node1_Label = Node1.label || 'None';
                                const Node1_Money = Node1_edge.money || 'None';
                                const Node1_PNumber = Node1_edge.p_number || 'None';
                                const Node1_SNumber = Node1_edge.s_number || 'None';
                                const Node1_PName = Node1_edge.p_name || 'None';
                                const Node1_Detail = Node1_edge.s_detail || 'None';
                                const Node2_Number = Node2.number || 'None';
                                const Node2_Name = Node2.name || 'None';
                                const Node2_Label = Node2.label || 'None';
                                const Node2_Money = Node2_edge.money || 'None';
                                const Node2_PNumber = Node2_edge.p_number || 'None';
                                const Node2_SNumber = Node2_edge.s_number || 'None';
                                const Node2_PName = Node2_edge.p_name || 'None';
                                const Node2_Detail = Node2_edge.s_detail || 'None';
                                const Node3_Number = Node3.number || 'None';
                                const Node3_Name = Node3.name || 'None';
                                const Node3_Label = Node3.label || 'None';
                                const Node3_Money = Node3_edge.money || 'None';
                                const Node3_PNumber = Node3_edge.p_number || 'None';
                                const Node3_SNumber = Node3_edge.s_number || 'None';
                                const Node3_PName = Node3_edge.p_name || 'None';
                                const Node3_Detail = Node3_edge.s_detail || 'None';

                                table += `<tr>
                                            <td>${Node1_number}</td>
                                            <td>${Node1_Name}</td>
                                            <td>${Node1_Label}</td>
                                            <td>${Node1_Money}</td>
                                            <td>${Node1_PNumber}</td>
                                            <td>${Node1_SNumber}</td>
                                            <td>${Node1_PName}</td>
                                            <td>${Node1_Detail}</td>
                                            <td>${Node2_Number}</td>
                                            <td>${Node2_Name}</td>
                                            <td>${Node2_Label}</td>
                                            <td>${Node2_Money}</td>
                                            <td>${Node2_PNumber}</td>
                                            <td>${Node2_SNumber}</td>
                                            <td>${Node2_PName}</td>
                                            <td>${Node2_Detail}</td>
                                            <td>${Node3_Number}</td>
                                            <td>${Node3_Name}</td>
                                            <td>${Node3_Label}</td>
                                            <td>${Node3_Money}</td>
                                            <td>${Node3_PNumber}</td>
                                            <td>${Node3_SNumber}</td>
                                            <td>${Node3_PName}</td>
                                            <td>${Node3_Detail}</td>


                                        </tr>`;
                            });
                            table += '</tbody></table>';

                            output.textContent = state + "æˆ‘ä¸€å…±æ‰¾åˆ°äº†" + totalCount + "æ¡ä¿¡æ¯,å¹¶ä»¥è¡¨æ ¼å’Œå›¾çš„å½¢å¼å±•ç¤º";


                            newTableContainer.innerHTML = table;
                            var newOutputContainer = document.createElement('div');
                            newOutputContainer.className = 'output-container'; // æ·»åŠ ä¸€ä¸ªç±»åï¼Œä»¥ä¾¿äºæ ·å¼ç®¡ç†
                            // å°†è¡¨æ ¼å®¹å™¨æ·»åŠ åˆ°è¾“å‡ºå®¹å™¨ä¸­
                            newOutputContainer.appendChild(newTableContainer);
                            newOutputContainer.style.marginTop = '20px';
                            newOutputContainer.style.width = '100%';
                            var historyContainer = document.getElementById('history');
                            // å°†æ–°çš„è¾“å‡ºå®¹å™¨æ·»åŠ åˆ°å†å²å®¹å™¨ä¸­
                            historyContainer.appendChild(newOutputContainer);


                            // Create a new canvas for D3 visualization
                            var newCanvasContainer = document.createElement('div');
                            newCanvasContainer.id = 'CanvasContainer' + Date.now(); // Unique ID using timestamp
                            newCanvasContainer.className = 'canvas-container';
                            newCanvasContainer.style.marginTop = '20px';
                            newCanvasContainer.style.width = '100%';

                            newOutputContainer.appendChild(newCanvasContainer); //è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯newChatContainer
                            var historyContainer = document.getElementById('history');
                            historyContainer.appendChild(newOutputContainer);
                            const width = 1200;
                            const height = 400;
                            const svg = d3.select(historyContainer).append('svg')
                            .attr('width', width)
                            .attr('height', height)
                            .style('display', 'block') // å°†SVGå…ƒç´ è®¾ç½®ä¸ºå—çº§å…ƒç´ 
                            .style('margin', 'auto'); // ä½¿ç”¨margin:autoæ¥ä½¿SVGæ°´å¹³å±…ä¸­

                            const tooltip = d3.select('body').append('div')
                            .attr('class', 'tooltip');

                          // Create a force simulation
                          const simulation = d3.forceSimulation()
                            .force('link', d3.forceLink().id(d => d.number).distance(100).strength(0.2))
                            .force('charge', d3.forceManyBody().strength(-200))
                            .force('center', d3.forceCenter(width / 2, height / 2))
                            .force('x', d3.forceX(width / 2).strength(0.1))
                            .force('y', d3.forceY(height / 2).strength(0.1));

                          // Extract nodes and links from the data
                          const paths = decodedData.output.data.data;
                          const nodesMap = new Map();
                          const links = [];

                          for (let i = 0; i < paths.length; i++) {
                            const pathNodes = paths[i].path;
                            for (let j = 0; j < pathNodes.length; j += 2) {
                              if (pathNodes[j].Node) {
                                  // Node
                                  const node = {
                                      number: pathNodes[j].Node.number,
                                      name: pathNodes[j].Node.name,
                                      label: pathNodes[j].Node.label
                                  };


                                // Add node to the map to remove duplicates
                                nodesMap.set(node.number, node);

                                // Edge
                                if (j < pathNodes.length - 1 && pathNodes[j + 1].HAS_DEBT) {
                                  // Target node for the edge
                                  const targetNode = {
                                    number: pathNodes[j + 2].Node.number,
                                    name: pathNodes[j + 2].Node.name,
                                    label: pathNodes[j + 2].Node.label
                                  };

                                  // Create the link
                                  const edge = {
                                    source: node.number,
                                    target: targetNode.number,
                                    head_name : pathNodes[j].Node.name,
                                    tail_name : pathNodes[j + 2].Node.name,
                                    value: pathNodes[j + 1].HAS_DEBT.money,
                                    p_number: pathNodes[j + 1].HAS_DEBT.p_number,
                                    s_number: pathNodes[j + 1].HAS_DEBT.s_number,
                                    p_name: pathNodes[j + 1].HAS_DEBT.p_name,
                                    s_detail: pathNodes[j + 1].HAS_DEBT.s_detail
                                  };

                                  // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å…·æœ‰ç›¸åŒ p_number çš„è¾¹
                                    const isDuplicate = links.some(link => link.p_number === edge.p_number);

                                    // å¦‚æœä¸å­˜åœ¨é‡å¤çš„è¾¹ï¼Œåˆ™æ·»åŠ è¿™æ¡æ–°è¾¹
                                    if (!isDuplicate) {
                                      links.push(edge);
                                    }
                                }
                              }
                            }
                          }
                          console.log(links)
                            // åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œä»¥èŠ‚ç‚¹å¯¹ä¸ºé”®
                            const edgeMap = {};
                            // éå†æ‰€æœ‰çš„è¾¹ï¼Œå°†ç›¸åŒèŠ‚ç‚¹å¯¹åº”çš„è¾¹ä¿¡æ¯åˆå¹¶
                            links.forEach(edge => {
                                const key = edge.source + '-' + edge.target; // ä»¥æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹ç»„åˆä½œä¸ºé”®
                                if (!edgeMap[key]) {
                                    // å¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™å°†å½“å‰è¾¹ä¿¡æ¯ä½œä¸ºå€¼å­˜å‚¨
                                    edgeMap[key] = edge;
                                } else {
                                    // å¦‚æœé”®å·²ç»å­˜åœ¨ï¼Œåˆ™åˆå¹¶è¾¹ä¿¡æ¯
                                    const existingEdge = edgeMap[key];
                                    existingEdge.head_name = [existingEdge.head_name]
                                    existingEdge.tail_name = [existingEdge.tail_name]
                                    existingEdge.value = [existingEdge.value];
                                    existingEdge.p_number = [existingEdge.p_number];
                                    existingEdge.s_number = [existingEdge.s_number];
                                    existingEdge.p_name = [existingEdge.p_name];
                                    existingEdge.s_detail = [existingEdge.s_detail];

                                    existingEdge.head_name.push(edge.head_name);
                                    existingEdge.tail_name.push(edge.tail_name);
                                    existingEdge.value.push(edge.value);// åˆå¹¶è¾¹çš„å€¼
                                    existingEdge.p_number.push(edge.p_number);// åˆå¹¶è¾¹çš„å€¼
                                    existingEdge.s_number.push(edge.s_number);// åˆå¹¶è¾¹çš„å€¼
                                    existingEdge.p_name.push(edge.p_name);// åˆå¹¶è¾¹çš„å€¼
                                    existingEdge.s_detail.push(edge.s_detail);// åˆå¹¶è¾¹çš„å€¼
                                    // è¿™é‡Œæ‚¨å¯èƒ½è¿˜éœ€è¦åˆå¹¶å…¶ä»–å±æ€§
                                }
                            });

                            // å°†åˆå¹¶åçš„è¾¹ä¿¡æ¯è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾›ç»˜åˆ¶
                            const mergedEdges = Object.values(edgeMap);
                            console.log(mergedEdges)
                          // Convert nodesMap to an array for rendering
                          const nodes = Array.from(nodesMap.values());

                          // Add links
                          const link = svg.selectAll('.link')
                            .data(mergedEdges)
                            .enter().append('line')
                            .attr('class', 'link')
                            .attr('stroke', 'red') // è®¾ç½®è¾¹çš„é¢œè‰²
                            .attr('stroke-width', 4) // è®¾ç½®è¾¹çš„å®½åº¦
                            .on('mouseover', showEdgeInfo)
                            .on('mouseout', hideTooltip);


                          // Add nodes
                          const node = svg.selectAll('.node')
                            .data(nodes)
                            .enter().append('circle')
                            .attr('class', 'node')
                            {#.attr('r', 10)#}
                            .attr('r', function(d, i) {
                                return i === 0 ? '15' : '10';
                            })
                            .attr('fill', function(d, i) { // æ ¹æ®ç´¢å¼•è®¾ç½®èŠ‚ç‚¹çš„é¢œè‰²
                                return i === 0 ? 'green' : '#ccc'; // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè®¾ç½®ä¸ºè“è‰²ï¼Œå¦åˆ™è®¾ç½®ä¸ºé»˜è®¤é¢œè‰²
                            })
                            .on('mouseover', showNodeInfo)
                            .on('mouseout', hideTooltip)
                            .call(d3.drag()
                              .on('start', dragstarted)
                              .on('drag', dragged)
                              .on('end', dragended));

                          // Add labels to nodes
                          const label = svg.selectAll('.label')
                            .data(nodes)
                            .enter().append('text')
                            .attr('class', 'label')
                            .attr('dx', 12)
                            .attr('dy', '.35em')
                            .text(d => splitText(d.name));

                          function splitText(text) {
                            const maxLength = 5; // æ¯è¡Œæœ€å¤šæ˜¾ç¤ºçš„å­—æ•°
                            const lines = [];
                            for (let i = 0; i < text.length; i += maxLength) {
                                lines.push(text.substr(i, maxLength));
                            }
                            return lines.join('\n'); // ä½¿ç”¨æ¢è¡Œç¬¦è¿æ¥å¤šè¡Œæ–‡æœ¬
                        }
                          // Update positions each tick
                          simulation.nodes(nodes)
                            .on('tick', () => {

                              link
                                .attr('x1', d => Math.max(0, Math.min(width, d.source.x)))
                                .attr('y1', d => Math.max(0, Math.min(height, d.source.y)))
                                .attr('x2', d => Math.max(0, Math.min(width, d.target.x)))
                                .attr('y2', d => Math.max(0, Math.min(height, d.target.y)));

                              node
                                .attr('cx', d => Math.max(0, Math.min(width, d.x)))
                                .attr('cy', d => Math.max(0, Math.min(height, d.y)));

                              label
                                .attr('x', d => Math.max(0, Math.min(width, d.x)))
                                .attr('y', d => Math.max(0, Math.min(height, d.y)));
                            });

                          simulation.force('link').links(links);
                          function dragstarted(event, d) {
                            if (!event.active) simulation.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                          }

                          function dragged(event, d) {
                            d.fx = event.x;
                            d.fy = event.y;
                          }

                          function dragended(event, d) {
                            if (!event.active) simulation.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                          }

                          function showNodeInfo(event, d) {
                            tooltip.transition()
                              .duration(200)
                              .style('opacity', 0.9);
                            tooltip.html(`<strong>èŠ‚ç‚¹åç§°ï¼š</strong> ${d.name}<br><strong>èŠ‚ç‚¹ç¼–å·:</strong> ${d.number}<br><strong>å•ä½æ€§è´¨:</strong> ${d.label}`)
                              .style('left', (event.pageX) + 'px')
                              .style('top', (event.pageY - 28) + 'px');
                          }

                          function showEdgeInfo(event, d) {
                            tooltip.transition()
                              .duration(200)
                              .style('opacity', 0.9);
                                tooltip.html(`<table>

                                                  <tbody>
                                                    <tr>
                                                      <td><strong>å¤´èŠ‚ç‚¹:</strong></td>
                                                      <td>${d.head_name}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>å°¾èŠ‚ç‚¹:</strong></td>
                                                      <td>${d.tail_name}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>é¡¹ç›®åç§°:</strong></td>
                                                      <td>${d.p_name}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>åº”ä»˜é‡‘é¢:</strong></td>
                                                      <td>${d.value}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>é¡¹ç›®ç¼–å·:</strong></td>
                                                      <td>${d.p_number}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>ä¸šåŠ¡æ˜ç»†ç¼–å·:</strong></td>
                                                      <td>${d.s_number}</td>
                                                    </tr>
                                                    <tr>
                                                      <td><strong>ä¸šåŠ¡æ˜ç»†åç§°:</strong></td>
                                                      <td>${d.s_detail}</td>
                                                    </tr>
                                                  </tbody>
                                                </table>`)
                              .style('left', (event.pageX) + 'px')
                              .style('top', (event.pageY - 28) + 'px');
                          }

                          function hideTooltip() {
                            tooltip.transition()
                              .duration(500)
                              .style('opacity', 0);
                          }

                            }
                            else
                            {
                                console.error('Unknown output_type:', output_type);
                            }
                        }
                    }

                    output.scrollTop = output.scrollHeight;
                    if (chatDiv.scrollHeight > chatDiv.clientHeight) {
                        chatDiv.scrollTop = Math.floor(chatDiv.scrollHeight - chatDiv.clientHeight);
                    }
                }
                    xhr.send();

            });


        cancelBtn.addEventListener("click", function() {
            if (xhr && xhr.readyState !== XMLHttpRequest.DONE) {
              xhr.abort();
            }
            xhr = new XMLHttpRequest();
            xhr.open("GET", "/cancel");
            xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
            xhr.send();
            input.value = '';
            });


        // å½“æŒ‰ä½æŒ‰é’®æ—¶å‘é€è¯·æ±‚
        audioBtn.addEventListener("mousedown", function() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/recordStart", true);
            xhr.send();
        });

        // å½“æ¾å¼€æŒ‰é’®æ—¶å‘é€è¯·æ±‚
        audioBtn.addEventListener("mouseup", function() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/recordStop", true);
            xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var text = xhr.responseText;
                input.value = text
            }
          };
            xhr.send();

        });

        // å½“ç§»å¼€æŒ‰é’®æ—¶å‘é€è¯·æ±‚
        audioBtn.addEventListener("mouseleave", function() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/recordLeave", true);
            xhr.send();
        });



</script>

</body>


<style>


    .container {
        display: flex; /* è®¾ç½®å®¹å™¨ä¸ºå¼¹æ€§å¸ƒå±€ */
        flex-direction: column; /* è®¾ç½®å­å…ƒç´ æ²¿å‚ç›´æ–¹å‘æ’åˆ— */
        align-items: center; /* æ°´å¹³å±…ä¸­ */
        gap: 10px; /* è®¾ç½®å…ƒç´ é—´éš”ä¸º10px */
    }


    .history-container {
        margin-left: 5%;
        margin-right: 5%;
}
    #outputContainer {
            margin-top: 20px;
            max-width: 80%;
        }
    .container1 {
  display: flex; /* è®¾ç½®å®¹å™¨ä¸ºå¼¹æ€§å¸ƒå±€ */
  justify-content: center; /* æ°´å¹³å±…ä¸­ */
  gap: 0px; /* è®¾ç½®å…ƒç´ é—´éš”ä¸º10px */
  height: 45px; /* è®¾ç½®é«˜åº¦ */
  position: absolute;
  bottom: 20px;
  left: 35%;
  right: 35%;
}

    #input, #audio-btn, #cancel-btn, #start-btn {
  height: 42px; /* è®¾ç½®é«˜åº¦ */
  box-sizing: border-box; /* è®¾ç½®ç›’æ¨¡å‹ä¸ºborder-boxï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶å…ƒç´ å°ºå¯¸ */
  border-radius: 20px; /* è®¾ç½®æ–‡æœ¬æ¡†çš„åœ†è§’ */
  font-size: 18px; /* è®¾ç½®å­—ä½“å¤§å° */
  padding: 5px; /* è®¾ç½®å†…è¾¹è· */
  margin: 5px; /* è®¾ç½®å¤–è¾¹è· */
  vertical-align: middle; /* å‚ç›´å±…ä¸­ */
}

#input {
  width: 550px; /* è®¡ç®—æ–‡æœ¬æ¡†çš„å®½åº¦ */
}

#audio-btn, #cancel-btn, #start-btn {
  width: 80px; /* è®¾ç½®æŒ‰é’®çš„å®½åº¦ */
}

#start-btn {
  background-color: green; /* è®¾ç½®å‘é€æŒ‰é’®çš„èƒŒæ™¯è‰²ä¸ºç»¿è‰² */
  border-color: black;
  color: white; /* è®¾ç½®å‘é€æŒ‰é’®çš„å­—ä½“é¢œè‰²ä¸ºç™½è‰² */
  {#border: none; /* ç§»é™¤è¾¹æ¡† */#}
}

#cancel-btn {
  background-color: red; /* è®¾ç½®å–æ¶ˆæŒ‰é’®çš„èƒŒæ™¯è‰²ä¸ºçº¢è‰² */
  border-color: black;
  color: white; /* è®¾ç½®å–æ¶ˆæŒ‰é’®çš„å­—ä½“é¢œè‰²ä¸ºç™½è‰² */
  {#border: none; /* ç§»é™¤è¾¹æ¡† */#}
}

#audio-btn {
  font-size: 30px; /* è®¾ç½®éº¦å…‹é£æŒ‰é’®çš„å­—ä½“å¤§å° */
  border: none; /* ç§»é™¤è¾¹æ¡† */
  background-color: transparent; /* ç§»é™¤èƒŒæ™¯è‰² */
  cursor: pointer; /* æ·»åŠ æ‰‹å‹å…‰æ ‡ */
}
svg {
      {#border: 1px solid #ccc;#}
    }

.link {
      stroke: red;
      stroke-width: 4;
    }
.node{

}
.tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      padding: 5px;
      opacity: 0;
      pointer-events: none;
    }
.node:nth-child(1) {
    fill: blue;
}
.label {
    font-size: 12px; /* è®¾ç½®å­—ä½“å¤§å°ä¸º 12 åƒç´  */
}
    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 10px; /* è®¾ç½®å­—ä½“å¤§å°ä¸º 10px */
    }

    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

  .tooltip table {
    border-collapse: collapse;
    border: 1px solid black; /* è®¾ç½®è¡¨æ ¼è¾¹æ¡† */
  }
  .tooltip th, .tooltip td {
    border: 1px solid black; /* è®¾ç½®è¡¨å¤´å•å…ƒæ ¼å’Œæ•°æ®å•å…ƒæ ¼è¾¹æ¡† */
    padding: 8px; /* æ·»åŠ ä¸€äº›å†…è¾¹è· */
  }
</style>

</html>